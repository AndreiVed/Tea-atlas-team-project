<!DOCTYPE html>
<html>
<head>
    <title>Автентифікація Google</title>
    <script>
        // Функція для отримання параметрів з URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded fired."); // Додайте цей лог
            const code = getUrlParameter('code');
            const state = getUrlParameter('state');
            console.log("Code:", code, "State:", state); // Додайте цей лог

            const backendLoginUrl = 'https://tea-atlas-backend.onrender.com/api/v1/google_auth/login/';
            const frontendHomeUrl = 'https://tea-atlas.onrender.com/';

            if (code) {
                console.log("Attempting to send POST request..."); // Додайте цей лог
                fetch(backendLoginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code, state: state })
                })
                .then(response => {
                    console.log("Received response from backend POST:", response); // Додайте цей лог
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Помилка автентифікації на бекенді'); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Parsed data from backend POST:", data); // Додайте цей лог
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    window.location.href = frontendHomeUrl;
                })
                .catch(error => {
                    console.error('Fetch error:', error); // Додайте цей лог
                    alert('Помилка входу через Google. Спробуйте ще раз: ' + error.message);
                    window.location.href = frontendHomeUrl;
                });
            } else {
                console.log("Code not found in URL."); // Додайте цей лог
                alert('Не отримано код авторизації від Google.');
                window.location.href = frontendHomeUrl;
            }
        });

        // Функція для отримання куки CSRF (якщо потрібно)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</head>
<body>
    <p>Обробка входу через Google...</p>
    <p>Будь ласка, зачекайте, вас буде перенаправлено.</p>
</body>
</html>